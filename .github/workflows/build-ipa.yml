name: Build SFI

on:
  workflow_dispatch:
  schedule:
    - cron: '10 15 * * *'

permissions:
  contents: write
  actions: write

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: set version
        run: |
          echo "SING_VERSION=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | perl -ne 'if(/"tag_name":\s*"v([0-9a-zA-Z\.-]+)"/){ print "$1\n"; last }')" >> $GITHUB_ENV
          echo "SING_IOS_VERSION=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | perl -ne 'if(/"tag_name":\s*"v([0-9a-zA-Z\.-]+)"/){ print "$1\n"; last }')" >> $GITHUB_ENV
        shell: bash

      - name: set variables
        id: set_variables
        run: |
          echo "sing-box-v${{ env.SING_VERSION }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.SING_VERSION }}" == "${{ env.SING_IOS_VERSION }}" ]; then
            echo "SING_VERSION_MATCH=true" >> $GITHUB_ENV
          else
            echo "SING_VERSION_MATCH=false" >> $GITHUB_ENV
          fi

      - name: Checkout this repo
        if: ${{ env.SING_VERSION_MATCH != 'true' }}
        uses: actions/checkout@main

      - name: Setup Go
        if: ${{ env.SING_VERSION_MATCH != 'true' }}
        uses: actions/setup-go@v5
        with:
          go-version: ^1.23

      - name: Setup Xcode stable
        if: ${{ env.SING_VERSION_MATCH != 'true' }}
        run: |-
          sudo xcode-select -s /Applications/Xcode.app

      - name: Build IPA
        if: ${{ env.SING_VERSION_MATCH != 'true' }}
        run: |
          cd $HOME

          git clone -b v${{ env.SING_VERSION }} --recurse-submodules --depth 1 https://github.com/SagerNet/sing-box.git
          cd $HOME/sing-box

          make lib_install
          export PATH="$PATH:$(go env GOPATH)/bin"
          go run ./cmd/internal/build_libbox -target apple -platform ios
          mv Libbox.xcframework clients/apple

          export XCODEPROJ_NAME=sing-box
          export APPLICATION_NAME=sing-box
          export SCHEME_NAME=SFI

          cd clients/apple

          xcodebuild \
            -project $XCODEPROJ_NAME.xcodeproj \
            -scheme $SCHEME_NAME \
            -destination 'generic/platform=iOS' \
            -configuration Release \
            -sdk iphoneos \
            -archivePath build/SFI.xcarchive \
            archive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGN_ENTITLEMENTS="" \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            ARCHS="arm64" \
            ONLY_ACTIVE_ARCH=NO \
            ENABLE_BITCODE=NO \
            STRIP_INSTALLED_PRODUCT=NO \
            COPY_PHASE_STRIP=NO \
            GCC_OPTIMIZATION_LEVEL=s \
            SWIFT_OPTIMIZATION_LEVEL=-O

          mkdir -p build/Payload
          cp -r build/SFI.xcarchive/Products/Applications/$APPLICATION_NAME.app build/Payload/

          rm -rf build/Payload/$APPLICATION_NAME.app/_CodeSignature
          rm -f build/Payload/$APPLICATION_NAME.app/embedded.mobileprovision
          
          cd build
          zip -qry $APPLICATION_NAME.ipa Payload
          
          mv $APPLICATION_NAME.ipa ${GITHUB_WORKSPACE}/${APPLICATION_NAME}-${{ env.SING_VERSION }}.ipa
          cd ${GITHUB_WORKSPACE}
          
          # ç¡®è®¤æ–‡ä»¶å­˜åœ¨
          if [ -f "${APPLICATION_NAME}-${{ env.SING_VERSION }}.ipa" ]; then
            echo "âœ… IPA æ–‡ä»¶åˆ›å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            ls -lh ${APPLICATION_NAME}-${{ env.SING_VERSION }}.ipa
          else
            echo "âŒ IPA æ–‡ä»¶åˆ›å»ºå¤±è´¥" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          shasum -a 256 ${APPLICATION_NAME}-${{ env.SING_VERSION }}.ipa > checksum.txt
          echo "### æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- ç‰ˆæœ¬: v${{ env.SING_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- é…ç½®: Release (ä¼˜åŒ–ç‰ˆ)" >> $GITHUB_STEP_SUMMARY
          echo "- æž¶æž„: arm64" >> $GITHUB_STEP_SUMMARY
          ls -lh ${APPLICATION_NAME}-${{ env.SING_VERSION }}.ipa | awk '{print "- å¤§å°: " $5}' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SHA256 æ ¡éªŒå’Œ" >> $GITHUB_STEP_SUMMARY
          cat checksum.txt >> $GITHUB_STEP_SUMMARY

      - name: Check files before release
        if: ${{ env.SING_VERSION_MATCH != 'true' }}
        run: |
          echo "=== å·¥ä½œç›®å½•å†…å®¹ ===" 
          ls -lah ${GITHUB_WORKSPACE}
          echo ""
          echo "=== å‡†å¤‡ä¸Šä¼ çš„æ–‡ä»¶ ==="
          ls -lh sing-box-${{ env.SING_VERSION }}.ipa checksum.txt

      - name: Create Release and Upload IPA
        if: ${{ env.SING_VERSION_MATCH != 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.SING_VERSION }}
          name: sing-box ${{ env.SING_VERSION }}
          draft: false
          prerelease: false
          generate_release_notes: false
          body: |
            ## sing-box ${{ env.SING_VERSION }} (Release ä¼˜åŒ–ç‰ˆ)
            
            ### âœ… å·²ä¿®å¤
            - ä½¿ç”¨ Release é…ç½® (æ€§èƒ½ä¼˜åŒ–)
            - ç§»é™¤è°ƒè¯•ç¬¦å· (å‡å°‘å´©æºƒ)
            - æ¸…ç†ç­¾åæ®‹ç•™ (å…¼å®¹æ€§æ›´å¥½)
            - ä¼˜åŒ–ç¼–è¯‘é€‰é¡¹ (ç¨³å®šæ€§æå‡)
            
            ### ðŸ“¦ æ­¤ä¸ºæ— ç­¾å IPA
            éœ€è¦ä½¿ç”¨ç­¾åå·¥å…·å®‰è£…,æŽ¨è:
            - **AltStore** / **Sideloadly** (7å¤©ç­¾å)
            - **çˆ±æ€åŠ©æ‰‹** / **ç‰›è›™åŠ©æ‰‹** (ä¼ä¸šç­¾å)
            - **Xcode** (å¼€å‘è€…ç­¾å)
            
            ### ðŸ”— ä¸Šæ¸¸é¡¹ç›®
            https://github.com/SagerNet/sing-box
          files: |
            sing-box-${{ env.SING_VERSION }}.ipa
            checksum.txt
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify Release Created
        if: ${{ env.SING_VERSION_MATCH != 'true' }}
        run: |
          echo "=== éªŒè¯ Release æ˜¯å¦åˆ›å»ºæˆåŠŸ ==="
          sleep 5
          if gh release view v${{ env.SING_VERSION }} --repo ${{ github.repository }}; then
            echo "âœ… Release åˆ›å»ºæˆåŠŸ!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Release åˆ›å»ºå¤±è´¥!" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete Old Workflows
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 3
          keep_minimum_runs: 3
